# TeachAid 配置管理功能使用手册

## 📋 概述

TeachAid 平台的配置管理功能为管理员提供了一个强大的工具来动态管理系统设置、安全策略、用户权限和登录监控。管理员可以通过直观的界面轻松配置各种系统参数，无需修改代码即可调整系统行为。

## 🚀 主要功能

### 1. 系统设置管理
- **动态配置**：无需重启即可修改大部分系统参数
- **分类管理**：按功能模块组织设置项
- **类型验证**：支持字符串、数字、布尔值、JSON等数据类型
- **权限控制**：不同设置项可要求不同角色权限

### 2. 安全策略管理
- **登录安全策略**：失败次数限制、账户锁定等
- **密码安全策略**：复杂度要求、过期时间等
- **会话管理策略**：超时设置、并发限制等
- **访问控制策略**：IP限制、时间限制等

### 3. 登录监控与日志
- **实时监控**：登录成功/失败统计
- **安全分析**：可疑IP识别、风险评估
- **详细日志**：完整的登录记录和审计追踪
- **用户管理**：批量用户操作、状态管理

## 🛠 安装和配置

### 步骤 1: 数据库更新

首先运行数据库更新脚本来创建必要的表结构：

```bash
cd llm_generated/2025-09-21/配置管理功能
python update_database.py
```

### 步骤 2: 初始化配置数据

运行初始化脚本来创建默认的系统设置和安全策略：

```bash
python init_config_data.py
```

### 步骤 3: 重启应用

重启 TeachAid 应用以使新功能生效：

```bash
# 开发环境
python app/main.py

# 生产环境
uvicorn app.main:app --host 0.0.0.0 --port 50001
```

### 步骤 4: 验证安装

运行测试脚本验证功能是否正常：

```bash
python test_config_management.py
```

## 📊 功能使用指南

### 系统设置管理

#### 访问路径
管理员登录后，访问：**管理后台 → 配置管理 → 系统设置**

#### 主要操作

**1. 查看设置列表**
- 设置按分类组织显示（安全设置、系统设置、AI设置等）
- 每个设置显示当前值、描述和最后更新时间
- 支持按分类筛选

**2. 编辑设置**
- 点击"编辑"按钮修改设置值
- 根据设置类型显示相应的输入控件：
  - 文本输入：普通字符串设置
  - 数字输入：数值类型设置
  - 开关控件：布尔值设置
  - 下拉选择：预定义选项设置
- 实时验证输入格式和范围

**3. 创建新设置**
```json
{
  "category": "security",
  "setting_key": "max_login_attempts",
  "setting_value": "5",
  "value_type": "number",
  "display_name": "最大登录失败次数",
  "description": "用户连续登录失败超过此次数将被锁定",
  "input_type": "number",
  "validation_rule": "min:1,max:20"
}
```

#### 重要设置说明

**安全设置**
- `max_login_attempts`: 最大登录失败次数（默认：5）
- `lockout_duration_minutes`: 账户锁定时长（默认：30分钟）
- `password_min_length`: 密码最小长度（默认：8）
- `require_password_complexity`: 是否要求密码复杂度（默认：启用）
- `session_timeout_hours`: 会话超时时间（默认：8小时）

**系统设置**
- `system_name`: 系统显示名称
- `allow_user_registration`: 是否允许用户注册
- `default_user_role`: 新用户默认角色
- `max_file_upload_size_mb`: 文件上传大小限制

**AI设置**
- `default_ai_model`: 默认AI模型
- `enable_ai_conversation`: 是否启用AI对话
- `daily_ai_quota_per_user`: 用户每日AI使用配额

### 安全策略管理

#### 访问路径
**管理后台 → 配置管理 → 安全策略**

#### 策略类型

**1. 登录安全策略**
```json
{
  "policy_name": "登录安全策略",
  "policy_type": "login_security",
  "config": {
    "max_failed_attempts": 5,
    "lockout_duration_minutes": 30,
    "require_captcha_after_failures": 3,
    "track_ip_addresses": true,
    "suspicious_activity_threshold": 10
  },
  "applies_to_roles": ["admin", "teacher", "student"]
}
```

**2. 密码安全策略**
```json
{
  "config": {
    "min_length": 8,
    "require_uppercase": true,
    "require_lowercase": true,
    "require_numbers": true,
    "require_special_chars": true,
    "password_history_count": 5,
    "password_expiry_days": 90
  }
}
```

**3. 会话管理策略**
```json
{
  "config": {
    "max_concurrent_sessions": 3,
    "session_timeout_hours": 8,
    "idle_timeout_minutes": 30,
    "force_logout_on_password_change": true
  }
}
```

**4. 访问控制策略**
```json
{
  "config": {
    "ip_whitelist": ["192.168.1.0/24"],
    "ip_blacklist": ["suspicious.ip.addr"],
    "time_based_access": {
      "enabled": true,
      "allowed_hours": {"start": "08:00", "end": "22:00"},
      "allowed_days": [1, 2, 3, 4, 5, 6, 7]
    },
    "device_restrictions": {
      "max_devices_per_user": 5,
      "require_device_approval": false
    }
  }
}
```

### 登录监控与用户管理

#### 访问路径
**管理后台 → 配置管理 → 登录日志**

#### 功能特性

**1. 统计概览**
- 总登录次数、成功/失败比例
- 唯一用户数统计
- 锁定用户数量
- 今日失败尝试次数
- 可疑IP列表

**2. 登录日志查询**
- 按时间范围筛选
- 按登录状态筛选（成功/失败）
- 按用户筛选
- 支持分页浏览
- 显示详细信息：IP地址、用户代理、失败原因、风险评分

**3. 用户管理操作**
```bash
# 查看用户列表
GET /api/admin/users?page=1&page_size=20&role=student&status=active

# 更改用户状态
PUT /api/admin/users/{user_id}/status
{
  "status": "suspended",
  "reason": "违规操作"
}

# 解锁用户
POST /api/admin/users/{user_id}/unlock
```

## 🔧 API 接口文档

### 系统设置 API

```bash
# 获取系统设置列表
GET /api/admin/settings?category=security

# 创建系统设置
POST /api/admin/settings
{
  "category": "security",
  "setting_key": "new_setting",
  "setting_value": "value",
  "display_name": "新设置",
  "description": "设置描述"
}

# 更新系统设置
PUT /api/admin/settings/{setting_id}
{
  "setting_value": "new_value",
  "description": "更新后的描述"
}
```

### 安全策略 API

```bash
# 获取安全策略列表
GET /api/admin/security-policies?policy_type=login_security

# 创建安全策略
POST /api/admin/security-policies
{
  "policy_name": "新策略",
  "policy_type": "access_control",
  "config": {...},
  "applies_to_roles": ["student"]
}

# 更新安全策略
PUT /api/admin/security-policies/{policy_id}
{
  "config": {...},
  "priority": 10
}
```

### 登录监控 API

```bash
# 获取登录统计
GET /api/admin/login-stats?days=7

# 获取安全统计
GET /api/admin/security-stats

# 获取登录日志
GET /api/admin/login-logs?start_date=2024-01-01&end_date=2024-01-31&is_success=false
```

## 🔐 权限管理

### 角色权限说明

**管理员 (admin)**
- 完全访问所有配置功能
- 创建、修改、删除系统设置
- 管理安全策略
- 查看所有日志和统计
- 用户管理操作

**教师 (teacher)**
- 查看部分系统设置（只读）
- 查看自己相关的登录日志
- 无法修改系统配置

**学生 (student)**
- 无访问配置管理权限
- 只能查看个人登录记录

### 权限检查机制

所有配置管理 API 都使用 `require_admin` 依赖注入来确保只有管理员能够访问：

```python
@router.get("/settings")
async def get_settings(
    current_user: ConfigUser = Depends(require_admin),
    db: Session = Depends(get_db)
):
    # 只有管理员能访问
    pass
```

## 📈 监控和诊断

### 关键指标监控

**1. 安全指标**
- 失败登录率
- 账户锁定频率
- 可疑IP数量
- 密码重置频率

**2. 系统指标**
- 配置变更频率
- 用户活跃度
- 会话超时率
- API调用频率

**3. 性能指标**
- 登录响应时间
- 认证成功率
- 数据库查询性能
- 缓存命中率

### 日志分析

**审计日志示例**
```json
{
  "log_id": "uuid",
  "user_id": "admin_user_id",
  "action_type": "UPDATE_SETTING",
  "resource": "system_settings",
  "resource_id": "setting_id",
  "description": "更新系统设置: security.max_login_attempts",
  "ip_address": "192.168.1.100",
  "action_at": "2024-01-01T12:00:00Z",
  "status": "success"
}
```

## 🚨 故障排除

### 常见问题

**1. 配置更新不生效**
- 检查缓存是否已清理
- 确认配置格式正确
- 验证用户权限
- 查看错误日志

**2. 登录失败计数异常**
- 检查 `max_login_attempts` 设置
- 验证 `lockout_duration_minutes` 配置
- 查看用户表中的失败计数字段
- 检查时区设置

**3. 安全策略不生效**
- 确认策略优先级设置
- 检查适用角色配置
- 验证策略配置格式
- 查看策略激活状态

**4. 日志记录缺失**
- 检查数据库连接
- 验证表结构完整性
- 查看应用日志错误
- 确认中间件配置

### 调试工具

**1. 日志级别设置**
```python
# 在开发环境启用详细日志
import logging
logging.getLogger("app.services.auth_service").setLevel(logging.DEBUG)
```

**2. 配置验证脚本**
```bash
# 运行配置验证
python test_config_management.py
```

**3. 数据库诊断**
```sql
-- 检查锁定用户
SELECT user_name, user_failed_login_attempts, user_locked_until
FROM config_users
WHERE user_status = 'locked';

-- 查看最近登录失败
SELECT username, ip_address, failure_reason, logged_in_at
FROM log_login
WHERE is_success = 0
ORDER BY logged_in_at DESC
LIMIT 10;
```

## 🔄 最佳实践

### 安全配置建议

**1. 登录安全**
- 设置合理的失败次数限制（3-5次）
- 配置适当的锁定时间（15-60分钟）
- 启用验证码机制
- 监控异常登录模式

**2. 密码策略**
- 要求强密码（长度≥8，包含大小写、数字、特殊字符）
- 定期密码过期（90-180天）
- 禁止重复使用最近密码
- 提供密码强度指示器

**3. 会话管理**
- 设置合理的会话超时时间
- 限制并发会话数量
- 密码变更时强制重新登录
- 定期清理过期会话

### 运维建议

**1. 定期备份**
- 备份配置数据
- 导出重要设置
- 创建恢复计划
- 测试恢复流程

**2. 监控告警**
- 设置关键指标阈值
- 配置异常告警
- 建立响应流程
- 定期安全审计

**3. 更新维护**
- 定期更新安全策略
- 清理历史日志
- 优化数据库性能
- 更新文档记录

## 📞 技术支持

如果在使用过程中遇到问题，请按以下顺序尝试解决：

1. **查看本文档**：首先查看相关章节
2. **检查日志**：查看应用和数据库日志
3. **运行测试**：使用提供的测试脚本诊断
4. **联系支持**：提供详细的错误信息和复现步骤

### 联系方式
- **技术文档**：参考本手册和代码注释
- **测试脚本**：使用 `test_config_management.py`
- **诊断工具**：运行 `update_database.py` 验证数据库状态

---

📚 **相关文档**
- [API 接口文档](/docs)
- [数据库设计文档](./数据库设计.md)
- [安全策略说明](./安全策略.md)

🔄 **版本信息**
- 文档版本：v1.0.0
- 适用版本：TeachAid v1.0.0+
- 最后更新：2025年9月21日